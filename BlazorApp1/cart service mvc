public class CartService : ICartService
{
    private readonly ApplicationDbContext _context;

    public CartService(ApplicationDbContext context)
    {
        _context = context;
    }

    // ADD TO CART
    public void AddToCart(int productId, string userId)
    {
        // Get product
        var product = _context.Products.Find(productId);

        // Get existing cart
        var cart = _context.Orders
            .Include(x => x.OrderItems)
            .FirstOrDefault(x => x.UserId == userId && !x.IsPlaced);

        // If cart not exists â†’ create
        if (cart == null)
        {
            cart = new Order
            {
                UserId = userId,
                CreatedDate = DateTime.Now,
                IsPlaced = false,
                OrderItems = new List<OrderItem>()
            };

            _context.Orders.Add(cart);
            _context.SaveChanges();
        }

        // Check item exists
        var item = cart.OrderItems
            .FirstOrDefault(x => x.ProductId == productId);

        if (item == null)
        {
            cart.OrderItems.Add(new OrderItem
            {
                ProductId = productId,
                Quantity = 1,
                Price = product.Price
            });
        }
        else
        {
            item.Quantity++;
        }

        _context.SaveChanges();
    }

    // REMOVE FROM CART
    public void RemoveFromCart(int productId, string userId)
    {
        var cart = _context.Orders
            .Include(x => x.OrderItems)
            .FirstOrDefault(x => x.UserId == userId && !x.IsPlaced);

        if (cart == null) return;

        var item = cart.OrderItems
            .FirstOrDefault(x => x.ProductId == productId);

        if (item != null)
        {
            _context.OrderItems.Remove(item);
            _context.SaveChanges();
        }
    }

    // GET CART
    public Order GetCart(string userId)
    {
        return _context.Orders
            .Include(x => x.OrderItems)
            .ThenInclude(x => x.Product)
            .FirstOrDefault(x => x.UserId == userId && !x.IsPlaced);
    }
}











public async Task<IActionResult> Login(LoginVM model)
{
    var token = await _authService.LoginAsync(model);

    var handler = new JwtSecurityTokenHandler();
    var jwt = handler.ReadJwtToken(token);
    var claims = jwt.Claims.ToList();

    var identity = new ClaimsIdentity(
        claims,
        CookieAuthenticationDefaults.AuthenticationScheme
    );

    var principal = new ClaimsPrincipal(identity);

    await HttpContext.SignInAsync(
        CookieAuthenticationDefaults.AuthenticationScheme,
        principal
    );

    // ðŸ”¥ STORE JWT TOKEN (THIS WAS MISSING)
    Response.Cookies.Append("jwt_token", token, new CookieOptions
    {
        HttpOnly = true,
        Secure = true,
        SameSite = SameSiteMode.Strict
    });

    return RedirectToAction("Index", "Home");
}

public class ProductService : IProductService
{
    private readonly HttpClient client;
    private readonly IHttpContextAccessor _context;

    public ProductService(HttpClient client, IHttpContextAccessor context)
    {
        this.client = client;
        _context = context;
    }

    private void AddJwtHeader()
    {
        var token = _context.HttpContext?.Request.Cookies["jwt_token"];

        if (!string.IsNullOrEmpty(token))
        {
            client.DefaultRequestHeaders.Authorization =
                new AuthenticationHeaderValue("Bearer", token);
        }
    }

    public async Task<ProductVM> CreateProductAsync(ProductVM productVM)
    {
        AddJwtHeader(); // ðŸ”¥ IMPORTANT

        var json = JsonConvert.SerializeObject(productVM);
        var content = new StringContent(json, Encoding.UTF8, "application/json");

        var response = await client.PostAsync("api/ProductAPI", content);

        if (response.IsSuccessStatusCode)
        {
            var data = await response.Content.ReadAsStringAsync();
            return JsonConvert.DeserializeObject<ProductVM>(data);
        }
        return null;
    }

    public async Task<bool> DeleteProductAsync(int id)
    {
        AddJwtHeader(); // ðŸ”¥ IMPORTANT

        var response = await client.DeleteAsync($"api/ProductAPI/{id}");
        return response.IsSuccessStatusCode;
    }
}

builder.Services.AddHttpContextAccessor();

builder.Services.AddHttpClient<IProductService, ProductService>(client =>
{
    client.BaseAddress = new Uri("https://localhost:5001/");
});
