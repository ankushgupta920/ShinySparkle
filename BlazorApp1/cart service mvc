public interface ICartService
{
    void AddToCart(Product product);
    void RemoveFromCart(int productId);
    CartVM GetCart();
    void ClearCart();
}



public class CartService : ICartService
{
    private readonly IHttpContextAccessor _httpContextAccessor;
    private const string CartKey = "CART";

    public CartService(IHttpContextAccessor httpContextAccessor)
    {
        _httpContextAccessor = httpContextAccessor;
    }

    public void AddToCart(Product product)
    {
        var cart = GetCart();

        var item = cart.Items.FirstOrDefault(x => x.ProductId == product.ProductId);

        if (item == null)
        {
            cart.Items.Add(new CartItemVM
            {
                ProductId = product.ProductId,
                ProductName = product.ProductName,
                Price = product.Price,
                Quantity = 1
            });
        }
        else
        {
            item.Quantity++;
        }

        SaveCart(cart);
    }

    public void RemoveFromCart(int productId)
    {
        var cart = GetCart();
        cart.Items.RemoveAll(x => x.ProductId == productId);
        SaveCart(cart);
    }

    public CartVM GetCart()
    {
        var session = _httpContextAccessor.HttpContext.Session;
        var cartData = session.GetString(CartKey);

        if (string.IsNullOrEmpty(cartData))
            return new CartVM();

        return JsonConvert.DeserializeObject<CartVM>(cartData);
    }

    public void ClearCart()
    {
        _httpContextAccessor.HttpContext.Session.Remove(CartKey);
    }

    private void SaveCart(CartVM cart)
    {
        _httpContextAccessor.HttpContext.Session.SetString(
            CartKey,
            JsonConvert.SerializeObject(cart)
        );
    }
}






[Authorize] // Identity
[ApiController]
[Route("api/cart")]
public class CartController : ControllerBase
{
    private readonly ICartService _cartService;
    private readonly ApplicationDbContext _context;
    private readonly UserManager<IdentityUser> _userManager;

    public CartController(
        ICartService cartService,
        ApplicationDbContext context,
        UserManager<IdentityUser> userManager)
    {
        _cartService = cartService;
        _context = context;
        _userManager = userManager;
    }

    [HttpPost("add")]
    public IActionResult Add(int productId, int quantity)
    {
        if (quantity <= 0)
            return BadRequest("Invalid quantity");

        var product = _context.Products.Find(productId);
        if (product == null)
            return NotFound();

        _cartService.AddToCart(product, quantity);
        return Ok(_cartService.GetCart());
    }

    [HttpGet]
    public IActionResult GetCart()
    {
        return Ok(_cartService.GetCart());
    }

    [HttpPost("remove")]
    public IActionResult Remove(int productId)
    {
        _cartService.RemoveFromCart(productId);
        return Ok();
    }
}














public class CartService : ICartService
{
    private readonly ApplicationDbContext _context;

    public CartService(ApplicationDbContext context)
    {
        _context = context;
    }

    public void AddToCart(string userId, Product product)
    {
        // Get user's cart
        var cart = _context.Carts
            .Include(c => c.CartItems)
            .FirstOrDefault(c => c.UserId == userId);

        // If cart does not exist, create one
        if (cart == null)
        {
            cart = new Cart
            {
                UserId = userId,
                CartItems = new List<CartItem>()
            };
            _context.Carts.Add(cart);
        }

        // Check if product already exists
        var item = cart.CartItems
            .FirstOrDefault(x => x.ProductId == product.ProductId);

        if (item == null)
        {
            cart.CartItems.Add(new CartItem
            {
                ProductId = product.ProductId,
                Quantity = 1
            });
        }
        else
        {
            item.Quantity++;
        }

        _context.SaveChanges();
    }

    public void RemoveFromCart(string userId, int productId)
    {
        var cart = _context.Carts
            .Include(c => c.CartItems)
            .FirstOrDefault(c => c.UserId == userId);

        if (cart == null) return;

        var item = cart.CartItems
            .FirstOrDefault(x => x.ProductId == productId);

        if (item != null)
        {
            cart.CartItems.Remove(item);
            _context.SaveChanges();
        }
    }

    public Cart GetCart(string userId)
    {
        return _context.Carts
            .Include(c => c.CartItems)
            .ThenInclude(ci => ci.Product)
            .FirstOrDefault(c => c.UserId == userId);
    }

    public void ClearCart(string userId)
    {
        var cart = _context.Carts
            .Include(c => c.CartItems)
            .FirstOrDefault(c => c.UserId == userId);

        if (cart == null) return;

        _context.CartItems.RemoveRange(cart.CartItems);
        _context.SaveChanges();
    }
}

