public class CartService : ICartService
{
    private readonly ApplicationDbContext _context;

    public CartService(ApplicationDbContext context)
    {
        _context = context;
    }

    // ADD TO CART
    public void AddToCart(int productId, string userId)
    {
        // Get product
        var product = _context.Products.Find(productId);

        // Get existing cart
        var cart = _context.Orders
            .Include(x => x.OrderItems)
            .FirstOrDefault(x => x.UserId == userId && !x.IsPlaced);

        // If cart not exists â†’ create
        if (cart == null)
        {
            cart = new Order
            {
                UserId = userId,
                CreatedDate = DateTime.Now,
                IsPlaced = false,
                OrderItems = new List<OrderItem>()
            };

            _context.Orders.Add(cart);
            _context.SaveChanges();
        }

        // Check item exists
        var item = cart.OrderItems
            .FirstOrDefault(x => x.ProductId == productId);

        if (item == null)
        {
            cart.OrderItems.Add(new OrderItem
            {
                ProductId = productId,
                Quantity = 1,
                Price = product.Price
            });
        }
        else
        {
            item.Quantity++;
        }

        _context.SaveChanges();
    }

    // REMOVE FROM CART
    public void RemoveFromCart(int productId, string userId)
    {
        var cart = _context.Orders
            .Include(x => x.OrderItems)
            .FirstOrDefault(x => x.UserId == userId && !x.IsPlaced);

        if (cart == null) return;

        var item = cart.OrderItems
            .FirstOrDefault(x => x.ProductId == productId);

        if (item != null)
        {
            _context.OrderItems.Remove(item);
            _context.SaveChanges();
        }
    }

    // GET CART
    public Order GetCart(string userId)
    {
        return _context.Orders
            .Include(x => x.OrderItems)
            .ThenInclude(x => x.Product)
            .FirstOrDefault(x => x.UserId == userId && !x.IsPlaced);
    }
}